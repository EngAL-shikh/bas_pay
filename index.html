<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دليل ربط بوابة الدفع BAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The SPA is designed as a single-page, scrollable guide to mirror the procedural nature of the source document. It starts with a high-level interactive flowchart (using Chart.js) for a quick overview. Key sections include a clear prerequisites checklist and a tabbed interface for the detailed backend, frontend, and confirmation steps. This structure was chosen to guide the developer user logically from a broad understanding to specific implementation details, enhancing usability and comprehension over a static text document. Details from the PDF are added into collapsible accordions within each step to provide depth without overwhelming the user initially. -->
    <!-- Visualization & Content Choices: 1. Process Overview -> Goal: Organize/Inform -> Viz: Interactive Horizontal Bar Chart (Flowchart) -> Interaction: Clicking a step on the chart scrolls to the detailed text -> Justification: Provides an immediate, high-level visual map of the entire process. -> Library: Chart.js (Canvas). 2. Detailed Steps -> Goal: Inform -> Presentation: Tabbed Interface with collapsible accordions for API details -> Interaction: Clicking tabs reveals steps; clicking accordion headers reveals technical details (endpoints, JSON payloads). -> Justification: Organizes instructions into logical chunks (Backend, Frontend, Confirmation) and hides complex technical data by default, allowing developers to drill down when needed. -> Method: HTML/CSS/JS. 3. Prerequisites -> Goal: Inform -> Presentation: Styled Checklist. -> Method: HTML/Tailwind CSS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 450px;
            max-height: 60vh;
        }
        .tab-button.active {
            border-color: #8D7B68;
            background-color: #EFEBE5;
            color: #4A4A4A;
            font-weight: 700;
        }
        .tab-button {
             border-color: #DCD6CC;
        }
        code, pre {
            direction: ltr;
            text-align: left;
            font-family: 'Courier New', Courier, monospace;
        }
        .code-block {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }
        .accordion-header {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .accordion-header:hover {
            background-color: #f9f7f5;
        }
        .accordion-content {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-5xl px-4 py-8 sm:py-12">

        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-[#6B5B4B]">دليل ربط بوابة الدفع BAS</h1>
            <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto">هذا الدليل التفاعلي يوضح لك بالتفصيل كيفية ربط بوابة الدفع BAS مع تطبيق فلاتر والباك اند الخاص بك خطوة بخطوة.</p>
        </header>

        <main>
            <section id="overview" class="mb-16">
                <h2 class="text-3xl font-bold text-center mb-2 text-[#8D7B68]">نظرة عامة على تدفق العملية</h2>
                <p class="text-center mb-8 text-gray-600">هذا المخطط يوضح تسلسل الخطوات بين الأطراف المختلفة. اضغط على أي خطوة في المخطط للانتقال إلى شرحها التفصيلي.</p>
                <div class="chart-container bg-white p-4 rounded-lg shadow-md">
                    <canvas id="integrationFlowchart"></canvas>
                </div>
            </section>

            <section id="prerequisites" class="mb-16 bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-center mb-8 text-[#8D7B68]">المتطلبات الأساسية</h2>
                 <p class="text-center mb-8 text-gray-600 -mt-4">قبل البدء في عملية الربط، من المهم التأكد من توفر جميع المتطلبات اللازمة لضمان تجربة تكامل سلسة وناجحة.</p>
                <ul class="space-y-4 max-w-2xl mx-auto">
                    <li class="flex items-start">
                        <span class="text-xl text-[#A4907C] ml-4 mt-1">✔</span>
                        <div>
                            <h3 class="font-bold text-lg">حساب تاجر مع BAS</h3>
                            <p class="text-gray-600">يجب أن يكون لديك `client_id` و `client_secret` التي تم تزويدك بها من قبل بوابة الدفع BAS.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <span class="text-xl text-[#A4907C] ml-4 mt-1">✔</span>
                        <div>
                            <h3 class="font-bold text-lg">تثبيت حزمة Laravel SDK</h3>
                            <p class="text-gray-600">تأكد من تثبيت الحزمة `basgate/laravel-sdk` في مشروع لارافيل الخاص بك.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <span class="text-xl text-[#A4907C] ml-4 mt-1">✔</span>
                        <div>
                            <h3 class="font-bold text-lg">تثبيت حزمة Flutter SDK</h3>
                            <p class="text-gray-600">تأكد من إضافة حزمة `bas_pay_flutter` أو `bas_flutter_sdk` إلى مشروع فلاتر الخاص بك.</p>
                        </div>
                    </li>
                </ul>
            </section>

            <section id="steps" class="mb-16">
                <h2 class="text-3xl font-bold text-center mb-2 text-[#8D7B68]">خطوات الربط بالتفصيل</h2>
                <p class="text-center mb-8 text-gray-600">تنقسم عملية الربط إلى ثلاث مراحل رئيسية: إعداد المعاملة في الباك اند، عرض واجهة الدفع في التطبيق، وأخيراً تأكيد حالة الدفع بشكل آمن.</p>
                
                <div class="max-w-4xl mx-auto">
                    <div class="flex justify-center border-b border-gray-300 mb-6">
                        <button data-tab="backend" class="tab-button active text-lg py-3 px-6 border-b-2 transition-colors duration-300">أولاً: جهة الباك اند</button>
                        <button data-tab="frontend" class="tab-button text-lg py-3 px-6 border-b-2 transition-colors duration-300">ثانياً: جهة التطبيق</button>
                        <button data-tab="confirmation" class="tab-button text-lg py-3 px-6 border-b-2 transition-colors duration-300">ثالثاً: تأكيد الدفع</button>
                    </div>

                    <div id="backend" class="tab-content bg-white p-6 md:p-8 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold mb-4">الخطوة 1: إنشاء طلب الدفع (Initiate Transaction)</h3>
                        <p class="mb-6">مهمة الباك اند هي تحضير عملية الدفع بشكل آمن. يقوم الباك اند بالتواصل مع BAS لإنشاء معاملة والحصول على رمز فريد ومؤقت (`trxToken`) ضروري لإتمام العملية في التطبيق.</p>
                        <ol class="list-decimal list-inside space-y-3 text-gray-700 mb-6">
                            <li>عندما يضغط المستخدم على زر "الدفع" في تطبيق فلاتر، يرسل التطبيق تفاصيل الطلب (المبلغ، معرف الطلب) إلى الباك اند الخاص بك.</li>
                            <li>يقوم الباك اند بالتواصل مع BAS لإنشاء معاملة جديدة عبر استدعاء `sdk-initiate-transaction` API.</li>
                            <li>في هذا الطلب، يتم إرسال بيانات الطلب مثل `amount`, `orderId`, و `customerInfo`.</li>
                            <li>إذا نجح الطلب، ترد BAS بكائن يحتوي على `trxToken`. هذا الرمز صالح لمدة 15 دقيقة.</li>
                            <li>يقوم الباك اند بحفظ `trxToken` مع تفاصيل الطلب في قاعدة البيانات، ثم يرسل هذا الرمز **فقط** إلى تطبيق فلاتر.</li>
                        </ol>
                        
                        <div class="accordion border rounded-lg">
                            <div class="accordion-header p-4 flex justify-between items-center">
                                <h4 class="font-bold text-lg">تفاصيل API: sdk-initiate-transaction</h4>
                                <span class="text-xl transform transition-transform duration-300">+</span>
                            </div>
                            <div class="accordion-content max-h-0 px-4 pb-0">
                                <p class="font-semibold mt-2">POST: <code>{{baseUrl}}/api/v1/merchant/sdk-payment/initiate-transaction</code></p>
                                <h5 class="font-bold mt-4 mb-2">Request Body:</h5>
                                <div class="code-block">
<pre><code>
{
  "head": {
    "signature": "D8DPA/BCJEPASdWcBUQjiQs...",
    "requestTimestamp": 1726355943223
  },
  "body": {
    "amount": {
      "value": 200,
      "currency": "YER"
    },
    "customerInfo": {
      "id": "69055"
    },
    "ordertype": "PayBill",
    "orderId": "{{order_id}}",
    "requestTimestamp": 1726355943223,
    "appId": "ac90ddd1-6627-4ae9-b268-98c17bd8ee6c"
  }
}
</code></pre>
                                </div>
                                <h5 class="font-bold mt-4 mb-2">Successful Response Body:</h5>
                                <div class="code-block">
<pre><code>
{
  "status": 1,
  "code": "1111",
  "messages": ["Success"],
  "head": { ... },
  "body": {
    "appId": "ac90ddd1-6627-4ae9-b268-98c17bd8ee6c",
    "trxStatus": "received",
    "trxId": "03a5fcf5-95a5-4c80-b226-c834fa651662",
    "trxToken": "30+4uC003UgkYWM5MGRkZDEt...YTFh",
    "authenticated": true,
    ...
  }
}
</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="frontend" class="tab-content hidden bg-white p-6 md:p-8 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold mb-4">الخطوة 2: استدعاء واجهة الدفع (Call BAS Payment SDK)</h3>
                        <p class="mb-6">بعد الحصول على رمز المعاملة من الباك اند، يأتي دور تطبيق فلاتر في استخدام هذا الرمز لعرض واجهة الدفع الآمنة للمستخدم. هذه الواجهة مُدارة بالكامل بواسطة BAS SDK.</p>
                        <ol class="list-decimal list-inside space-y-3 mb-6 text-gray-700">
                           <li>بمجرد استلام `trxToken` من الباك اند، يقوم التطبيق باستدعاء دالة `callBasPaymentSdk`.</li>
                           <li>وفقًا للتوثيق، تقوم هذه الدالة بدورها باستدعاء `sdk-pre-initialize-pay` API لجلب طرق الدفع المتاحة وعرضها للمستخدم.</li>
                           <li>عندما يختار المستخدم طريقة الدفع ويكمل العملية (مثل إدخال OTP)، تقوم SDK باستدعاء `sdk-initiate-payment` و `sdk-confirm-payment` في الخلفية.</li>
                           <li>أخيرًا، تقوم SDK بإغلاق واجهتها وإرجاع النتيجة (نجاح أو فشل) إلى تطبيق فلاتر عبر دوال الـ Callback.</li>
                        </ol>
                        
                        <div class="code-block">
<pre><code>
// استدعاء الدالة الرئيسية في فلاتر
callBasPaymentSdk(
  context: context,
  trxToken: theTrxTokenReceivedFromBackend,
  userPhone: "777777777",
  fullName: "Ali Ahmed",
  onSuccess: (TrxModel result) {
    print("Payment Successful: ${result.trxId}");
  },
  onError: (Map&lt;String, dynamic&gt;? error) {
    print("Payment Failed: ${error.toString()}");
  },
);
</code></pre>
                        </div>

                         <div class="accordion border rounded-lg mt-6">
                            <div class="accordion-header p-4 flex justify-between items-center">
                                <h4 class="font-bold text-lg">تفاصيل API (خلف الكواليس)</h4>
                                <span class="text-xl transform transition-transform duration-300">+</span>
                            </div>
                            <div class="accordion-content max-h-0 px-4 pb-0">
                                <h5 class="font-bold mt-2 mb-2">1. sdk-pre-initialize-pay</h5>
                                <p class="mb-2 text-sm text-gray-600">لجلب طرق الدفع المتاحة.</p>
                                <div class="code-block">
<pre><code>
// Request Body
{
  "trxToken": "{{trx_token}}"
}
</code></pre>
                                </div>
                                <h5 class="font-bold mt-4 mb-2">2. sdk-initiate-payment</h5>
                                <p class="mb-2 text-sm text-gray-600">لبدء عملية الدفع بعد اختيار المستخدم لطريقة الدفع.</p>
                                <div class="code-block">
<pre><code>
// Request Body
{
  "customerPaymentMethodId": 100000006,
  "trxToken":"{{trx_token}}",
  "account": "776111582",
  "phoneNumber": "776111582",
  "fullName": "YouYou Ahmed",
  "extraFields": {
    "account": "776111582"
  }
}
</code></pre>
                                </div>
                                 <h5 class="font-bold mt-4 mb-2">3. sdk-confirm-payment</h5>
                                 <p class="mb-2 text-sm text-gray-600">لتأكيد الدفع بعد إدخال المستخدم للمعلومات المطلوبة (مثل OTP).</p>
                                <div class="code-block">
<pre><code>
// Request Body
{
  "customerPaymentMethodId": 100000006,
  "appId": "cc3bba90-90c8-4ddb-9dce-07ca75e67994",
  "trxToken": "{{trx_token}}",
  "account": "776111582",
  "pgTransactionToken": "trxToken",
  "extraFields": {
    "account": "776111582",
    "OTP": "123456"
  }
}
</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="confirmation" class="tab-content hidden bg-white p-6 md:p-8 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold mb-4">الخطوة 4: التحقق من حالة المعاملة (Check Transaction Status)</h3>
                        <p class="mb-6">هذه الخطوة ضرورية لضمان أمان وموثوقية العملية. يجب على الباك اند التحقق مباشرة من BAS لضمان أن المعاملة قد تمت بنجاح بالفعل.</p>
                        <ol class="list-decimal list-inside space-y-3 text-gray-700 mb-6">
                            <li>بعد استدعاء دالة `onSuccess` في التطبيق، يجب على التطبيق إرسال طلب آخر للباك اند ليخبره أن المستخدم أكمل الدفع من جهته.</li>
                            <li><strong>نقطة هامة:</strong> يقوم الباك اند بخطوة تحقق أخيرة ومباشرة مع BAS.</li>
                            <li>يستدعي الباك اند `check-transaction-status` API من BAS، ويرسل `trxId` أو `orderId`.</li>
                            <li>ترد BAS بالحالة النهائية والمؤكدة للمعاملة (`processed`, `failed`, etc.).</li>
                            <li>بناءً على هذا الرد، يقوم الباك اند بتحديث حالة الطلب في قاعدة البيانات (مثلاً، "مدفوع").</li>
                        </ol>
                         <div class="accordion border rounded-lg">
                            <div class="accordion-header p-4 flex justify-between items-center">
                                <h4 class="font-bold text-lg">تفاصيل API: check-transaction-status</h4>
                                <span class="text-xl transform transition-transform duration-300">+</span>
                            </div>
                            <div class="accordion-content max-h-0 px-4 pb-0">
                                <p class="font-semibold mt-2">POST: <code>{{baseUrl}}/api/v1/merchant/secure/transaction/status</code></p>
                                <h5 class="font-bold mt-4 mb-2">Request Body:</h5>
                                <div class="code-block">
<pre><code>
{
  "head": {
    "signature": "D8DPABCJePASdWcBUQjiQs...",
    "requestTimestamp": "1726355943223"
  },
  "body": {
    "appId": "ac90ddd1-6627-4ae9-b268-98c17bd8ee6c",
    "orderId": "1425164d-e932-41fc-9bd5-5fb83ef73c45",
    "trxId": "ab9cbca6-219d-43bc-ae0f-689b21da46d7",
    "requestTimestamp": "1726355943223"
  }
}
</code></pre>
                                </div>
                                <h5 class="font-bold mt-4 mb-2">Successful Response Body:</h5>
                                <div class="code-block">
<pre><code>
{
  "head": { ... },
  "body": {
    "trxStatus": "processed",
    "trxId": "ab9cbca6-219d-43bc-ae0f-689b21da46d7",
    "trxToken": "yHE4Q+nY3IjR3ZCsJ2bpS...",
    "trxStatusId": 1202,
    ...
    "order": { ... }
  }
}
</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const flowchartData = {
            labels: [
                '1. التطبيق يطلب الدفع من الباك اند',
                '2. الباك اند ينشئ المعاملة مع BAS',
                '3. الباك اند يرسل trxToken للتطبيق',
                '4. التطبيق يستدعي BAS SDK',
                '5. المستخدم يكمل عملية الدفع',
                '6. التطبيق يبلغ الباك اند بالنجاح',
                '7. الباك اند يتحقق من الحالة مع BAS'
            ],
            datasets: [
                {
                    label: 'جهة التطبيق (Frontend)',
                    data: [1, 0, 0, 1, 0, 1, 0],
                    backgroundColor: '#A4907C',
                    borderColor: '#8D7B68',
                    borderWidth: 1,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7
                },
                {
                    label: 'جهة الباك اند (Backend)',
                    data: [0, 1, 1, 0, 0, 0, 1],
                    backgroundColor: '#C8B6A6',
                    borderColor: '#A4907C',
                    borderWidth: 1,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7
                },
                {
                    label: 'المستخدم',
                    data: [0, 0, 0, 0, 1, 0, 0],
                    backgroundColor: '#EFEBE5',
                    borderColor: '#DCD6CC',
                    borderWidth: 1,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7
                }
            ]
        };

        const flowchartConfig = {
            type: 'bar',
            data: flowchartData,
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false, stacked: true },
                    y: {
                        stacked: true,
                        ticks: { font: { family: "'Tajawal', sans-serif", size: 14 } }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { font: { family: "'Tajawal', sans-serif", size: 14 } }
                    },
                    tooltip: { enabled: false }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        let targetId = index <= 2 ? 'backend' : (index <= 4 ? 'frontend' : 'confirmation');
                        
                        document.getElementById('steps').scrollIntoView({ behavior: 'smooth' });
                        
                        document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));

                        const targetTab = document.querySelector(`button[data-tab="${targetId}"]`);
                        const targetContent = document.getElementById(targetId);
                        if(targetTab && targetContent) {
                            targetTab.classList.add('active');
                            targetContent.classList.remove('hidden');
                        }
                    }
                }
            }
        };
        
        function setupAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('span');
                    
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.style.transform = 'rotate(45deg)';
                    }
                });
            });
        }

        window.onload = function() {
            const ctx = document.getElementById('integrationFlowchart').getContext('2d');
            const integrationFlowchart = new Chart(ctx, flowchartConfig);

            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.toggle('hidden', content.id !== target);
                    });
                });
            });
            
            setupAccordions();
        };
    </script>
</body>
</html>

